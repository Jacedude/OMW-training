<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMW 2026 Training Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <!-- FIREBASE SDK SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // TODO: PASTE YOUR FIREBASE CONFIGURATION HERE
       const firebaseConfig = {
          apiKey: "AIzaSyDF83iwy1tQg9Cwjx0YI6gg5VlYyt-YP6U",
          authDomain: "old-man-winter-training.firebaseapp.com",
          projectId: "old-man-winter-training",
          storageBucket: "old-man-winter-training.firebasestorage.app",
          messagingSenderId: "22870231666",
          appId: "1:22870231666:web:0ceecd1f157b9db910d0eb",
          measurementId: "G-SSLF0YRCWP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expose specific functions to the global window object so Babel/React can see them
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #error-box { display: none; padding: 20px; background: #450a0a; color: #fecaca; border: 1px solid #991b1b; margin: 20px; border-radius: 8px; font-family: monospace; }
        textarea { resize: none; }
        /* Spinner for loading state */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerHTML = `<strong>App Crash Detected:</strong><br>${msg}<br><small>${url}:${line}:${col}</small>`;
            console.error("Global Error:", error);
            return false;
        };
    </script>
</head>
<body>
    <div id="error-box"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState('');
            useEffect(() => {
                if (window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                    setSvgHtml(window.lucide.icons[name].toSvg({ class: className, width: size, height: size, "stroke-width": 2 }));
                }
            }, [name, size, className]);
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'inline-flex' }} />;
        };

        // Icon Mappings
        const CalendarIcon = (p) => <Icon name="Calendar" {...p} />;
        const LayoutDashboard = (p) => <Icon name="LayoutDashboard" {...p} />;
        const Flame = (p) => <Icon name="Flame" {...p} />;
        const Activity = (p) => <Icon name="Activity" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Clock = (p) => <Icon name="Clock" {...p} />;
        const CheckSquare = (p) => <Icon name="CheckSquare" {...p} />;
        const Square = (p) => <Icon name="Square" {...p} />;
        const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
        const Coffee = (p) => <Icon name="Coffee" {...p} />;
        const Utensils = (p) => <Icon name="Utensils" {...p} />;
        const Zap = (p) => <Icon name="Zap" {...p} />;
        const Droplets = (p) => <Icon name="Droplets" {...p} />;
        const Wind = (p) => <Icon name="Wind" {...p} />;
        const Thermometer = (p) => <Icon name="Thermometer" {...p} />;
        const CloudRain = (p) => <Icon name="CloudRain" {...p} />;
        const Info = (p) => <Icon name="Info" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Dumbbell = (p) => <Icon name="Dumbbell" {...p} />;
        const MessageSquare = (p) => <Icon name="MessageSquare" {...p} />;
        const Pill = (p) => <Icon name="Pill" {...p} />;
        const Bike = (p) => <Icon name="Bike" {...p} />;
        const Waves = (p) => <Icon name="Waves" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const RefreshCcw = (p) => <Icon name="RefreshCw" {...p} />;
        const PlayCircle = (p) => <Icon name="PlayCircle" {...p} />;

        // --- CONSTANTS & DATA (SAME AS BEFORE) ---
        const SUPPLEMENT_INFO = {
          "Creatine": { type: "Daily", title: "Creatine Monohydrate", dose: "5g Daily (Post)", why: "Critical for high-torque gravel surges. Acts as a larger battery for sprinting." },
          "Beta-Ala": { type: "Daily", title: "Beta-Alanine", dose: "3.2g Daily", why: "Buffers intracellular acid. Reduces 'burn' in 10k/Intervals. Causes harmless tingling." },
          "D3+K2": { type: "Daily", title: "Vitamin D3+K2", dose: "5000IU", why: "Bone health & immune support. K2 directs calcium to bones, not arteries." },
          "Caffeine": { type: "Acute", title: "Caffeine", dose: "200mg (T-45m)", why: "Lowers RPE. Mobilizes fat. Essential for race starts." },
          "Bicarb": { type: "Acute", title: "Sodium Bicarbonate", dose: "20g (Protocol)", why: "Extracellular buffering. Sucks acid out of muscles. swallow whole." },
          "Nitrates": { type: "Acute", title: "Beet Shot", dose: "400mg", why: "Improves O2 efficiency at altitude." },
          "Sodium": { type: "Acute", title: "Sodium Load", dose: "1500mg", why: "Expands plasma volume for altitude and cooling." }
        };

        const INTRA_FUEL_OPTIONS = {
            'High': { target: '100g/hr', options: ["Combo A: 2 scoops Go-To + Hydrogel (100g)", "Combo B: 2 scoops Skratch + Bloks (88g)", "Combo C: 3 scoops Go-To + Picky Bar (100g)"] },
            'Moderate': { target: '50g/hr', options: ["Combo A: 1 scoop Go-To + Picky Bar (50g)", "Combo B: 1.5 scoops Skratch + Bloks (54g)", "Combo C: 2 scoops Go-To (50g)"] },
            'Low': { target: '0g/hr', options: ["Water + Electrolytes Only", "Diluted Skratch if needed"] }
        };

        const RECOVERY_ROUTINES = {
  'A': { 
    id: 'A', title: "Routine A: The Flush", sub: "Parasympathetic Reset", time: "10m", 
    steps: [
      { name: "Legs Up Wall", time: "3m", gif: "https://www.spotebi.com/wp-content/uploads/2016/01/legs-up-the-wall-pose-viparita-karani-spotebi.gif" },
      { name: "Box Breathing", time: "2m", gif: "https://media.giphy.com/media/krP2NRkLqnKEg/giphy.gif" },
      { name: "Light Calf Roll", time: "2m", gif: "https://post.healthline.com/wp-content/uploads/2020/06/400x400_Foam_Roller_Exercises_Calves.gif" },
      { name: "Child's Pose", time: "2m", gif: "https://www.spotebi.com/wp-content/uploads/2015/05/child-pose-balasana-spotebi.gif" },
      { name: "Hydrate", time: "16oz", gif: null }
    ] 
  },
  'B': { 
    id: 'B', title: "Routine B: The Unlock", sub: "Hip & Spine Mobility", time: "10m", 
    steps: [
      { name: "T-Spine Extension", time: "2m", gif: "https://post.healthline.com/wp-content/uploads/2020/06/400x400_Foam_Roller_Exercises_Upper_Back.gif" },
      { name: "Couch Stretch", time: "2m/side", gif: "https://www.spotebi.com/wp-content/uploads/2016/08/quadriceps-stretch-exercise-illustration-spotebi.gif" },
      { name: "90/90 Hip Switch", time: "2m", gif: "https://media.giphy.com/media/vk3EkIVRsfBuOAJ5G2/giphy.gif" },
      { name: "Cat/Cow", time: "2m", gif: "https://www.spotebi.com/wp-content/uploads/2015/05/cat-cow-stretch-spotebi.gif" },
      { name: "Deep Squat Hold", time: "2m", gif: "https://www.spotebi.com/wp-content/uploads/2015/01/squat-hold-spotebi.gif" }
    ] 
  },
  'C': { 
    id: 'C', title: "Routine C: The Release", sub: "Deep Tissue", time: "10m", 
    steps: [
      { name: "Gun: Glute Medius", time: "2m", gif: "https://media.giphy.com/media/QCB2i0He6v40rA5lTH/giphy.gif" },
      { name: "Gun: Quads/VMO", time: "2m", gif: "https://media.giphy.com/media/QCB2i0He6v40rA5lTH/giphy.gif" },
      { name: "Roll IT Band", time: "2m", gif: "https://post.healthline.com/wp-content/uploads/2020/06/400x400_Foam_Roller_Exercises_IT_Band.gif" },
      { name: "Pigeon Pose", time: "2m", gif: "https://www.spotebi.com/wp-content/uploads/2015/05/pigeon-pose-kapotasana-spotebi.gif" },
      { name: "Hamstring Floss", time: "2m", gif: "https://www.spotebi.com/wp-content/uploads/2016/01/lying-hamstring-stretch-spotebi.gif" }
    ] 
  },
  'D': { 
    id: 'D', title: "Routine D: The Foundation", sub: "Core Strength", time: "20m", 
    steps: [
      { name: "Pallof Press", time: "3x10", gif: "https://media.giphy.com/media/ss-onIwHVGQ/giphy.gif" },
      { name: "DB Goblet Squat", time: "3x12", gif: "https://www.spotebi.com/wp-content/uploads/2016/03/goblet-squat-exercise-illustration-spotebi.gif" },
      { name: "Dead Bug", time: "3x10", gif: "https://www.spotebi.com/wp-content/uploads/2015/05/dead-bug-exercise-illustration-spotebi.gif" },
      { name: "Band Clamshells", time: "3x15", gif: "https://www.spotebi.com/wp-content/uploads/2016/01/clamshell-exercise-illustration-spotebi.gif" },
      { name: "Plank Saw", time: "3x45s", gif: "https://www.spotebi.com/wp-content/uploads/2017/06/body-saw-plank-exercise-illustration-spotebi.gif" }
    ] 
  },
  'E': { 
    id: 'E', title: "Routine E: The Stabilizer", sub: "Ankle/Shoulder", time: "15m", 
    steps: [
      { name: "Mobo/Wobble Board", time: "3x1m", gif: "https://media.giphy.com/media/FWer4juebZM/giphy.gif" },
      { name: "DB Scaption", time: "3x10", gif: "https://media.giphy.com/media/365physique/giphy.gif" },
      { name: "Single Leg RDL", time: "3x10", gif: "https://www.spotebi.com/wp-content/uploads/2015/04/single-leg-deadlift-exercise-illustration-spotebi.gif" },
      { name: "Band Pull-Apart", time: "3x15", gif: "https://media.giphy.com/media/3366/giphy.gif" },
      { name: "Mobo Lateral Rock", time: "3x1m", gif: "https://media.giphy.com/media/FWer4juebZM/giphy.gif" }
    ] 
  }
};

        const FLUX_DATA = {
          'High': { color: 'green', desc: "PERFORMANCE. High carbs. No deficit.", preSwim: "Banana + Blank's Custom Mix (75g Carb)", b: "Oats + Banana + Syrup", l: "Rice Bowl + Chicken", d: "Pasta + Lean Beef", pre: "45g Carbs (Gel)", intra: "100g Carb/hr" },
          'Moderate': { color: 'yellow', desc: "MAINTENANCE. Fuel the work.", preSwim: "Banana OR Toast", b: "Yogurt + Berries", l: "Quinoa + Chicken", d: "Steak + Potato", pre: "Banana", intra: "50g Carb/hr" },
          'Low': { color: 'red', desc: "FAT LOSS. High protein, low starch.", preSwim: "Water / Coffee", b: "Veggie Omelet", l: "Salad + Tuna", d: "White Fish + Asparagus", pre: "Black Coffee", intra: "Water Only" }
        };

        const GEAR_MATRIX = {
  "10-20F": {
    "Bike": {
      "Dry": { u: "Mesh + Merino + Perfetto + Vest", l: "Sorpasso + Wind Brief", e: "Lobster Claws / Winter Boot", t: "Pirelli M (23/25psi)", w: "ADD: Hardshell Jkt + Goggles" },
      "Wet": { u: "Hardshell Jkt + Rain Trousers", l: "Rain Trousers", e: "Neoprene Gloves / Vapor Socks", t: "Pirelli M (22/24psi)", w: "ADD: Bar Mitts (Pogies)" }
    },
    "Run": {
      "Dry": { u: "Merino Base + Wind Shell", l: "Thermal Tights + Briefs", e: "Mittens / Wool Hat", f: "Gore-Tex Trail Shoe", w: "ADD: Facemask + Wind Briefs" },
      "Wet": { u: "Base + Waterproof Jkt", l: "Rain Pants", e: "Waterproof Mitten / Cap", f: "Gore-Tex + Wool Sock", w: "ADD: Ski Goggles" }
    }
  },
  "20-30F": {
    "Bike": {
      "Dry": { u: "Merino Base + Perfetto", l: "Sorpasso Tights", e: "Lobster Claws / Wool Sock", t: "Vittoria Dry (32/34psi)", w: "ADD: Wind Vest over Perfetto" },
      "Wet": { u: "Perfetto + Rain Shell", l: "Sorpasso (DWR)", e: "Neoprene Gloves", t: "Pirelli M (24/26psi)", w: "ADD: Velotoze + Helmet Cover" }
    },
    "Run": {
      "Dry": { u: "Synth LS + Vest", l: "Thermal Tights", e: "Light Gloves / Headband", f: "Standard Trail Shoe", w: "SWAP: Full Wind Jacket" },
      "Wet": { u: "Synth LS + Rain Shell", l: "Tights + Shell Short", e: "Waterproof Glove / Hat", f: "Gore-Tex Shoe", w: "ADD: Brimmed Hat" }
    }
  },
  "30-40F": {
    "Bike": {
      "Dry": { u: "Synth Base + Perfetto", l: "Sorpasso Tights", e: "Windproof Glove / Toe Covers", t: "Vittoria Dry (33/35psi)", w: "ADD: Ear Cover + Vest" },
      "Wet": { u: "Perfetto + Rain Vest", l: "Sorpasso + Ass Saver", e: "RoS Glove / Neoprene Bootie", t: "Pirelli M (25/27psi)", w: "SWAP: Full Rain Jacket" }
    },
    "Run": {
      "Dry": { u: "LS Tech Tee", l: "Light Tights", e: "Thin Gloves", f: "Standard Shoe", w: "ADD: Wind Vest + Briefs" },
      "Wet": { u: "LS Tee + Rain Vest", l: "Tights", e: "Cap", f: "Wool Socks", w: "SWAP: Full Rain Jacket" }
    }
  },
  "40-50F": {
    "Bike": {
      "Dry": { u: "Summer Base + Perfetto", l: "Sorpasso OR Bibs", e: "Light Full Finger", t: "Vittoria Dry (34/36psi)", w: "ADD: Vest (Core Warmth)" },
      "Wet": { u: "Perfetto (Closed Vents)", l: "Sorpasso (Nano Flex)", e: "Neoprene / Velotoze", t: "Pirelli M (26/28psi)", w: "ADD: Helmet Cover" }
    },
    "Run": {
      "Dry": { u: "Short Sleeve + Arm Warmers", l: "Shorts", e: "None", f: "Standard Shoe", w: "ADD: Gilet / Vest" },
      "Wet": { u: "Long Sleeve + Cap", l: "Shorts", e: "Light Gloves", f: "Standard Shoe", w: "ADD: Light Shell Jkt" }
    }
  },
  "50-60F": {
    "Bike": {
      "Dry": { u: "Jersey + Arm Warmers", l: "Bibs + Knee Warmers", e: "Fingerless Gloves", t: "Slicks (40psi)", w: "ADD: Wind Vest (Pocket)" },
      "Wet": { u: "Jersey + Rain Jacket", l: "Bibs + Embro", e: "Light Full Finger", t: "Mixed (38psi)", w: "NOTE: Zip Vents Closed" }
    },
    "Run": {
      "Dry": { u: "Singlet / T-Shirt", l: "Split Shorts", e: "Sunglasses", f: "Race Shoe", w: "None" },
      "Wet": { u: "T-Shirt + Cap", l: "Split Shorts", e: "Anti-Chafe Balm", f: "Standard Shoe", w: "ADD: Tight Layer (Flap)" }
    }
  },
  "60-70F": {
    "Bike": {
      "Dry": { u: "Summer Jersey", l: "Bib Shorts", e: "Fingerless Gloves", t: "Slicks (42psi)", w: "SWAP: Shallow Front Wheel" },
      "Wet": { u: "Jersey + Rain Vest", l: "Bibs", e: "Cap", t: "Mixed (38psi)", w: "SWAP: Full Rain Jacket" }
    },
    "Run": {
      "Dry": { u: "Singlet", l: "Split Shorts", e: "Visor", f: "Race Shoe", w: "None" },
      "Wet": { u: "Singlet", l: "Split Shorts", e: "Visor", f: "Drainable Shoe", w: "None" }
    }
  },
  "70-80F": {
    "Bike": {
      "Dry": { u: "Aero Jersey (Mesh)", l: "Aero Bibs", e: "Sun Sleeves", t: "Slicks (45psi)", w: "SWAP: Box Rim Wheel" },
      "Wet": { u: "Summer Jersey", l: "Bibs", e: "None", t: "Mixed (40psi)", w: "None" }
    },
    "Run": {
      "Dry": { u: "Singlet / Shirtless", l: "Short Shorts", e: "Ice Bandana", f: "Race Shoe", w: "ADD: Body Glide" },
      "Wet": { u: "Singlet", l: "Short Shorts", e: "Anti-Chafe", f: "Race Shoe", w: "None" }
    }
  },
  "80-90F": {
    "Bike": {
      "Dry": { u: "Climber's Jersey", l: "Lightweight Bibs", e: "Sunscreen", t: "Slicks", w: "Hydration: +1 Bottle/hr" },
      "Wet": { u: "Mesh Jersey", l: "Bibs", e: "None", t: "Slicks", w: "None" }
    },
    "Run": {
      "Dry": { u: "Shirtless / Mesh", l: "Shorts", e: "Handheld Water", f: "Vented Shoe", w: "ADD: Visor (Hair Control)" },
      "Wet": { u: "Singlet", l: "Shorts", e: "Anti-Chafe", f: "Vented Shoe", w: "None" }
    }
  },
  "90F+": {
    "Bike": {
      "Dry": { u: "Mesh Only / Wet Jersey", l: "Lightweight Bibs", e: "Ice Sock", t: "Slicks", w: "Alert: Salt Accumulation" },
      "Wet": { u: "Mesh Jersey", l: "Bibs", e: "None", t: "Slicks", w: "None" }
    },
    "Run": {
      "Dry": { u: "Shirtless", l: "Shorts", e: "Ice Hat / Pre-Cooling", f: "Vented Shoe", w: "Alert: High Evaporation" },
      "Wet": { u: "Singlet", l: "Shorts", e: "Anti-Chafe", f: "Vented Shoe", w: "None" }
    }
  }
};

        // --- FULL 9-WEEK SCHEDULE ---
        const WEEKS = {
          1: { title: "Phase 1: Build", focus: "Dec 1 - Dec 7", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "VO2 Intervals", dur: "50m", tss: 70, fl: "Moderate", rec: "B", goal: "Leg Speed", ex: ["6x800m @ 6:25"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Threshold Swim", dur: "1h", tss: 60, fl: "Moderate", rec: "D", goal: "Aerobic Power", ex: ["Continuous Laps"], supps: [] }, { t: "Run", title: "Easy Run", dur: "30m", tss: 30, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Strict Z2 (8:00+)"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Tempo Run", dur: "45m", tss: 60, fl: "High", rec: "C", goal: "Glycogen Deplete", ex: ["20m @ 7:10/mi"], supps: [] }, { t: "Bike", title: "Dbl Thresh", dur: "1h", tss: 75, fl: "High", rec: "C", goal: "Torque", ex: ["3x8m @ 250W"], supps: ["Caffeine", "Nitrates"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Easy Swim", dur: "45m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy Laps"], supps: [] }, { t: "Bike", title: "VO2 Max", dur: "1h", tss: 80, fl: "High", rec: "C", goal: "Raise Ceiling", ex: ["5x3m @ 315W"], supps: ["Caffeine"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "45m", tss: 25, fl: "Low", rec: "B", goal: "Parasympathetic", ex: ["Strict <150W"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Volume Swim", dur: "1h", tss: 45, fl: "Moderate", rec: "C", goal: "Volume", ex: ["Moderate"], supps: [] }, { t: "Bike", title: "Gravel Skills", dur: "2.5h", tss: 130, fl: "High", rec: "A", goal: "Handling", ex: ["Find Mud"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Long Run", dur: "1h 10m", tss: 70, fl: "High", rec: "A", goal: "Ankle Stability", ex: ["Trails"], supps: [] }] }
          ]},
          2: { title: "Phase 1: Build", focus: "Dec 8 - Dec 14", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Threshold Run", dur: "55m", tss: 75, fl: "Moderate", rec: "B", goal: "Race Pace Lock", ex: ["5x1000m @ 6:40"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Threshold Swim", dur: "1h", tss: 65, fl: "Moderate", rec: "D", goal: "Lactate Clear", ex: ["Threshold Pace"], supps: [] }, { t: "Run", title: "Easy Run", dur: "35m", tss: 35, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Strict Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Run (AM)", dur: "50m", tss: 65, fl: "High", rec: "C", goal: "Pre-Fatigue", ex: ["25m @ 7:00/mi"], supps: [] }, { t: "Bike", title: "Torque (PM)", dur: "1h 15m", tss: 95, fl: "High", rec: "C", goal: "Muscular Endur", ex: ["3x10m @ 250W"], supps: ["Caffeine", "Nitrates"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Sprints", dur: "1h", tss: 75, fl: "Moderate", rec: "E", goal: "Neuromuscular", ex: ["10x30s MAX"], supps: ["Caffeine"] }, { t: "Swim", title: "Easy Swim", dur: "45m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy Laps"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "1h", tss: 30, fl: "Low", rec: "B", goal: "Reset", ex: ["Strict <150W"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Volume Swim", dur: "1h", tss: 45, fl: "High", rec: "C", goal: "Volume", ex: ["Steady State"], supps: [] }, { t: "Bike", title: "Long Ride", dur: "3h", tss: 155, fl: "High", rec: "C", goal: "Fatigue Resist", ex: ["Endur"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Long Run", dur: "1h 15m", tss: 75, fl: "Moderate", rec: "A", goal: "Durability", ex: ["Hilly Route"], supps: [] }] }
          ]},
          3: { title: "Phase 1: Specificity", focus: "Dec 15 - Dec 21", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Mile Reps", dur: "1h", tss: 80, fl: "Moderate", rec: "B", goal: "VO2 Support", ex: ["3x1600m @ 6:40"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Threshold", dur: "1h", tss: 65, fl: "Moderate", rec: "D", goal: "Threshold", ex: ["Hard Intervals"], supps: [] }, { t: "Run", title: "Easy Run", dur: "40m", tss: 40, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Strict Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Run (AM)", dur: "50m", tss: 65, fl: "High", rec: "C", goal: "Lactate Shuttle", ex: ["2x15m @ 7:00"], supps: [] }, { t: "Bike", title: "Dbl Thresh (PM)", dur: "1h 15m", tss: 100, fl: "High", rec: "C", goal: "Raise Ceiling", ex: ["2x20m @ 250W"], supps: ["Caffeine", "Nitrates"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "VO2 Max", dur: "1h", tss: 85, fl: "Moderate", rec: "E", goal: "Torque", ex: ["6x3m @ 320W"], supps: ["Caffeine"] }, { t: "Swim", title: "Rec Swim", dur: "45m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "45m", tss: 25, fl: "Low", rec: "B", goal: "Reset", ex: ["Strict <150W"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Volume Swim", dur: "1h", tss: 45, fl: "Low", rec: "B", goal: "Volume", ex: ["Swim Early"], supps: [] }, { t: "Bike", title: "Sim 1", dur: "2.5h", tss: 140, fl: "High", rec: "C", goal: "Torque Endur", ex: ["Torque Endur"], supps: ["Sodium"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Long Run", dur: "1h 20m", tss: 80, fl: "Moderate", rec: "A", goal: "Base", ex: ["80m Trails"], supps: [] }] }
          ]},
          4: { title: "Phase 1: Specificity", focus: "Dec 22 - Dec 28", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Mile Reps", dur: "1h 5m", tss: 85, fl: "Moderate", rec: "B", goal: "Mental Toughness", ex: ["4x1600m @ 6:40"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Threshold", dur: "1h", tss: 65, fl: "Moderate", rec: "D", goal: "Power", ex: ["Hard Intervals"], supps: [] }, { t: "Run", title: "Easy Run", dur: "40m", tss: 40, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Strict Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "AM Brick", dur: "45m", tss: 65, fl: "High", rec: "C", goal: "Pre-Fatigue", ex: ["45m w/ 30m Tempo"], supps: ["Caffeine"] }, { t: "Bike", title: "Brick (PM)", dur: "1h 30m", tss: 110, fl: "High", rec: "C", goal: "Empty Tank", ex: ["90m w/ 3x15m 250W"], supps: ["Caffeine", "Nitrates"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Rest", title: "Travel Day", dur: "0m", tss: 0, fl: "Moderate", rec: "B", goal: "Compression", ex: ["Rest"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Travel Run", dur: "50m", tss: 65, fl: "Low", rec: "B", goal: "Maintenance", ex: ["20m @ 6:50"], supps: ["Caffeine"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Long Run", dur: "1h 30m", tss: 90, fl: "High", rec: "C", goal: "Volume", ex: ["Hilly Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Rec Swim", dur: "1h", tss: 45, fl: "Moderate", rec: "A", goal: "Offload Legs", ex: ["Aerobic"], supps: [] }] }
          ]},
          5: { title: "Phase 1: Travel", focus: "Dec 29 - Jan 4", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Best 10k", dur: "1h 10m", tss: 95, fl: "Moderate", rec: "B", goal: "Race Predictor", ex: ["3x2 Miles @ 6:45"], supps: ["Caffeine", "Nitrates", "Bicarb"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Mod Swim", dur: "1h", tss: 45, fl: "Moderate", rec: "D", goal: "Recovery", ex: ["Moderate"], supps: [] }, { t: "Run", title: "Easy Run", dur: "30m", tss: 30, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Z2 Jog"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Tempo", dur: "45m", tss: 60, fl: "High", rec: "C", goal: "Lactate Clear", ex: ["45m w/ 20m Tempo"], supps: ["Caffeine"] }, { t: "Swim", title: "Aquath", dur: "45m", tss: 60, fl: "High", rec: "C", goal: "Threshold", ex: ["20x100y"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Rest", title: "Travel Day", dur: "0m", tss: 0, fl: "Moderate", rec: "B", goal: "Hydrate", ex: ["Rest"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Active", dur: "1h", tss: 45, fl: "Low", rec: "B", goal: "Wake Legs", ex: ["Wake Legs"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Mod Swim", dur: "1h", tss: 45, fl: "High", rec: "C", goal: "Volume", ex: ["Moderate"], supps: [] }, { t: "Bike", title: "Gravel", dur: "3.5h", tss: 185, fl: "High", rec: "C", goal: "Equip Check", ex: ["3.5hrs Outdoor"], supps: ["Caffeine", "Nitrates", "Bicarb"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Peak Run", dur: "1h 30m", tss: 90, fl: "Moderate", rec: "A", goal: "Durability", ex: ["90m Z2"], supps: [] }] }
          ]},
          6: { title: "Phase 2: Peak", focus: "Jan 5 - Jan 11", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Speed", dur: "1h", tss: 85, fl: "Moderate", rec: "D", goal: "Over-Speed", ex: ["5x1200m @ 6:30"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Hard Swim", dur: "1h", tss: 65, fl: "Moderate", rec: "D", goal: "Power", ex: ["Threshold"], supps: [] }, { t: "Run", title: "Easy Run", dur: "40m", tss: 40, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Strict Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Tempo", dur: "45m", tss: 65, fl: "High", rec: "C", goal: "Pacing", ex: ["20m 10k Pace"], supps: [] }, { t: "Bike", title: "VO2 Max", dur: "1h 15m", tss: 85, fl: "High", rec: "C", goal: "Sharpness", ex: ["4x8@285"], supps: ["Caffeine", "Nitrates"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "VO2 Max", dur: "1h", tss: 85, fl: "Moderate", rec: "E", goal: "Sharpness", ex: ["8x2m"], supps: ["Caffeine"] }, { t: "Swim", title: "Easy Swim", dur: "45m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Recovery"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "45m", tss: 25, fl: "Low", rec: "B", goal: "Reset", ex: ["Strict <150W"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Sim 3", dur: "45m", tss: 65, fl: "High", rec: "C", goal: "Race Feel", ex: ["10k Tempo"], supps: ["Caffeine", "Bicarb"] }, { t: "Rest", title: "GAP", dur: "60m", tss: 0, fl: "High", rec: "A", goal: "Re-Warm", ex: ["Car Routine"], supps: ["Nitrates"] }, { t: "Bike", title: "Sim 3", dur: "2h", tss: 110, fl: "High", rec: "C", goal: "Fatigued Pwr", ex: ["3x10m @ 250W"], supps: ["Sodium"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Rec Run", dur: "45m", tss: 45, fl: "Low", rec: "B", goal: "Recovery", ex: ["Easy Z2"], supps: [] }] }
          ]},
          7: { title: "Phase 2: Peak/Taper", focus: "Jan 12 - Jan 18", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Taper", dur: "50m", tss: 65, fl: "Moderate", rec: "B", goal: "Form Focus", ex: ["6x800m @ 6:40"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Mod Swim", dur: "50m", tss: 40, fl: "Moderate", rec: "D", goal: "Maintain Feel", ex: ["Aerobic"], supps: [] }, { t: "Run", title: "Rec Run", dur: "30m", tss: 30, fl: "Moderate", rec: "D", goal: "Flush", ex: ["30m Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Dbl Taper", dur: "40m", tss: 55, fl: "High", rec: "C", goal: "Engine Check", ex: ["2x10m @ Tempo"], supps: [] }, { t: "Bike", title: "Dbl Taper", dur: "1h", tss: 75, fl: "High", rec: "C", goal: "Tension Check", ex: ["2x10m @ 250W"], supps: ["Caffeine"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Openers", dur: "45m", tss: 45, fl: "Moderate", rec: "E", goal: "Neuromuscular", ex: ["4x1m Fast Pedal"], supps: [] }, { t: "Swim", title: "Easy Swim", dur: "40m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "30m", tss: 15, fl: "Low", rec: "B", goal: "Rest", ex: ["Z1 Spin"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Easy Swim", dur: "45m", tss: 30, fl: "Moderate", rec: "A", goal: "Feel", ex: ["Easy"], supps: [] }, { t: "Bike", title: "Endur", dur: "2h", tss: 100, fl: "Moderate", rec: "B", goal: "Aerobic Maint", ex: ["2hrs Z2 Steady"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Taper Run", dur: "50m", tss: 50, fl: "Moderate", rec: "B", goal: "Aerobic Maint", ex: ["50m Z2"], supps: [] }] }
          ]},
          8: { title: "Phase 2: Taper", focus: "Jan 19 - Jan 25", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Sharp", dur: "40m", tss: 55, fl: "Moderate", rec: "B", goal: "Leg Speed", ex: ["4x400m @ 5k Pace"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Easy Swim", dur: "40m", tss: 30, fl: "Moderate", rec: "D", goal: "Recovery", ex: ["Easy"], supps: [] }, { t: "Run", title: "Rec Run", dur: "20m", tss: 20, fl: "Moderate", rec: "D", goal: "Flush", ex: ["20m Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Taper", dur: "30m", tss: 40, fl: "High", rec: "C", goal: "Priming", ex: ["10m @ Tempo"], supps: [] }, { t: "Bike", title: "Taper", dur: "45m", tss: 45, fl: "High", rec: "C", goal: "Priming", ex: ["3x30s Spin-ups"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Openers", dur: "45m", tss: 45, fl: "Moderate", rec: "E", goal: "Activation", ex: ["3x30s Spin-ups"], supps: [] }, { t: "Swim", title: "Easy Swim", dur: "40m", tss: 30, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "30m", tss: 15, fl: "Low", rec: "B", goal: "Rest", ex: ["Z1 Spin"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Act Swim", dur: "20m", tss: 15, fl: "Moderate", rec: "B", goal: "Feel", ex: ["Very Easy"], supps: [] }, { t: "Bike", title: "Act Spin", dur: "45m", tss: 35, fl: "Moderate", rec: "B", goal: "Spin", ex: ["45m Easy"], supps: [] }, { t: "Run", title: "Shakeout", dur: "40m", tss: 40, fl: "High", rec: "A", goal: "Easy", ex: ["40m Z2"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Run", title: "Shakeout", dur: "30m", tss: 30, fl: "High", rec: "A", goal: "Shakeout", ex: ["30m Jog"], supps: [] }] }
          ]},
          9: { title: "Phase 2: Race Week", focus: "Jan 26 - Feb 1", days: [
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Bike", title: "Rec Spin", dur: "30m", tss: 15, fl: "Low", rec: "A", goal: "Rest", ex: ["30m Z1 Spin"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Easy Swim", dur: "40m", tss: 30, fl: "Moderate", rec: "D", goal: "Flush", ex: ["Easy"], supps: [] }, { t: "Run", title: "Strides", dur: "30m", tss: 35, fl: "Moderate", rec: "D", goal: "Activation", ex: ["30m w/ 4x30s"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2", "Caffeine"], workouts: [{ t: "Bike", title: "Openers", dur: "45m", tss: 35, fl: "High", rec: "C", goal: "Race Priming", ex: ["2x3m @ 245W"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2"], workouts: [{ t: "Swim", title: "Easy Swim", dur: "30m", tss: 20, fl: "Moderate", rec: "E", goal: "Flush", ex: ["Easy"], supps: [] }, { t: "Run", title: "Jog", dur: "20m", tss: 15, fl: "Moderate", rec: "E", goal: "Shakeout", ex: ["20m Easy"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2", "Sodium"], workouts: [{ t: "Bike", title: "Load Spin", dur: "20m", tss: 10, fl: "High", rec: "B", goal: "Spin", ex: ["20m Spin", "Load"], supps: ["Sodium"] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2", "Sodium"], workouts: [{ t: "Bike", title: "Act Spin", dur: "15m", tss: 10, fl: "High", rec: "B", goal: "Checks", ex: ["15m Spin"], supps: ["Sodium"] }, { t: "Run", title: "Act Jog", dur: "10m", tss: 10, fl: "High", rec: "B", goal: "Checks", ex: ["10m Jog"], supps: [] }] },
              { stack: ["Creatine", "Beta-Ala", "D3+K2", "Caffeine", "Bicarb", "Nitrates"], workouts: [{ t: "Run", title: "OMW 10K", dur: "10K", tss: 100, fl: "High", rec: "A", goal: "EXECUTE", ex: ["Start 10:00 AM"], supps: ["Caffeine", "Bicarb", "Nitrates"] }, { t: "Rest", title: "GAP", dur: "90m", tss: 0, fl: "High", rec: "A", goal: "Refuel", ex: ["Dry Clothes", "Heat"], supps: [] }, { t: "Bike", title: "OMW 40mi", dur: "40mi", tss: 150, fl: "High", rec: "A", goal: "EXECUTE", ex: ["Start 12:00 PM"], supps: [] }] }
          ]}
        };

        // --- HELPER FUNCTIONS ---
        const getWorkoutDate = (week, dayIndex) => {
            // Week 1 starts Dec 1, 2025
            const startDate = new Date(2025, 11, 1); // Month is 0-indexed: 11 = Dec
            const dayOffset = (week - 1) * 7 + dayIndex;
            const targetDate = new Date(startDate);
            targetDate.setDate(startDate.getDate() + dayOffset);
            return targetDate;
        };

        const formatDate = (date) => {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        };

        // --- MAIN APP ---
        function TrainingApp() {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [week, setWeek] = useState(() => {
        const now = new Date();
        const start = new Date(2025, 11, 1); // Dec 1, 2025
    
        // Reset time to midnight for accurate day calculation
        now.setHours(0,0,0,0);
        start.setHours(0,0,0,0);
    
        const diffTime = now - start;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return 1; // Before start date, default to Week 1
        if (diffDays >= 63) return 9; // After end date, stay on Week 9
    
        return Math.floor(diffDays / 7) + 1;
});

    const [day, setDay] = useState(() => {
        const now = new Date();
        const start = new Date(2025, 11, 1);
    
        now.setHours(0,0,0,0);
        start.setHours(0,0,0,0);
    
        const diffTime = now - start;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return 0; // Monday
        if (diffDays >= 63) return 6; // Sunday
    
        return diffDays % 7;
});
          const [checkedItems, setCheckedItems] = useState({});
          const [comments, setComments] = useState({});
          const [targetRecovery, setTargetRecovery] = useState(null);
          const [activeSupplement, setActiveSupplement] = useState(null); 
          const [activeFuelProtocol, setActiveFuelProtocol] = useState(null);
          const [temp, setTemp] = useState("30-40F");
          const [cond, setCond] = useState("Dry");
          const USER_ID = "default_user";

          useEffect(() => {
             const loadData = async () => {
                if (!window.db) return;
                try {
                    const docRef = window.doc(window.db, "training_data", USER_ID);
                    const docSnap = await window.getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setCheckedItems(data.checked || {});
                        setComments(data.comments || {});
                    } else {
                        await window.setDoc(docRef, { checked: {}, comments: {} });
                    }
                } catch (e) {
                    console.error("Firebase Error:", e);
                }
             };
             setTimeout(loadData, 1000);
          }, []);

          const toggleCheck = async (id) => {
             const newCheckedState = !checkedItems[id];
             const newState = { ...checkedItems, [id]: newCheckedState };
             setCheckedItems(newState);
             
             if (window.db) {
                 const docRef = window.doc(window.db, "training_data", USER_ID);
                 await window.updateDoc(docRef, {
                     [`checked.${id}`]: newCheckedState
                 });
             }
          };

          const saveComment = async (id, text) => {
             const newState = { ...comments, [id]: text };
             setComments(newState);
             
             if (window.db) {
                 const docRef = window.doc(window.db, "training_data", USER_ID);
                 await window.updateDoc(docRef, {
                     [`comments.${id}`]: text
                 });
             }
          };

          const jumpToRecovery = (recId) => {
            setTargetRecovery(recId);
            setActiveTab('recovery');
          };

          const jumpToFuel = () => setActiveTab('fuel');

          const openFuelModal = (flux) => {
              setActiveFuelProtocol(flux);
          }

          const goToDay = (w, d) => {
            setWeek(w);
            setDay(d);
            setActiveTab('dashboard');
          };

          const weekData = WEEKS[week] || WEEKS[1];
          const dayData = weekData.days[day] || weekData.days[0];

          return (
            <div className="flex h-screen flex-col lg:flex-row bg-slate-950 text-slate-200 font-sans selection:bg-blue-500/30 overflow-hidden relative">
              
              {/* SUPPLEMENT MODAL */}
              {activeSupplement && (
                <div className="absolute inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setActiveSupplement(null)}>
                  <div className="bg-slate-900 border border-slate-700 p-6 rounded-md max-w-sm w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="text-xl font-bold text-white">{SUPPLEMENT_INFO[activeSupplement]?.title || activeSupplement}</h3>
                      <button onClick={() => setActiveSupplement(null)} className="text-slate-400 hover:text-white"><X size={20}/></button>
                    </div>
                    {SUPPLEMENT_INFO[activeSupplement] ? (
                      <div className="space-y-4">
                         <div className="bg-slate-800 p-3 rounded-md">
                           <div className="text-[10px] uppercase font-bold text-slate-500">Dose & Timing</div>
                           <div className="text-blue-400 font-bold">{SUPPLEMENT_INFO[activeSupplement].dose}</div>
                         </div>
                         <div>
                           <div className="text-[10px] uppercase font-bold text-slate-500 mb-1">Physiological Objective</div>
                           <p className="text-slate-300 text-sm leading-relaxed">{SUPPLEMENT_INFO[activeSupplement].why}</p>
                         </div>
                      </div>
                    ) : (
                      <p className="text-slate-400">No specific detail data for this supplement.</p>
                    )}
                  </div>
                </div>
              )}

              {/* FUEL MODAL */}
              {activeFuelProtocol && (
                <div className="absolute inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setActiveFuelProtocol(null)}>
                  <div className="bg-slate-900 border border-slate-700 p-6 rounded-md max-w-sm w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-start mb-4">
                      <div>
                          <h3 className="text-xl font-bold text-white">Intra-Workout Fueling</h3>
                          <p className="text-sm text-slate-400">{activeFuelProtocol} Flux â€¢ {INTRA_FUEL_OPTIONS[activeFuelProtocol]?.target}</p>
                      </div>
                      <button onClick={() => setActiveFuelProtocol(null)} className="text-slate-400 hover:text-white"><X size={20}/></button>
                    </div>
                    <div className="space-y-3">
                        <p className="text-[10px] uppercase font-bold text-slate-500">Recommended Options</p>
                        {INTRA_FUEL_OPTIONS[activeFuelProtocol]?.options.map((opt, i) => (
                            <div key={i} className="bg-slate-800 p-3 rounded-md text-sm text-slate-300 border border-slate-700">
                                {opt}
                            </div>
                        ))}
                    </div>
                  </div>
                </div>
              )}

              {/* NAV */}
              <nav className="fixed bottom-0 w-full lg:relative lg:w-64 bg-slate-900 border-t lg:border-t-0 lg:border-r border-slate-800 z-50 flex-shrink-0">
                <div className="flex lg:flex-col justify-around lg:justify-start h-full p-2 lg:p-6 gap-2">
                  <div className="hidden lg:block mb-8">
                    <h1 className="text-2xl font-black italic text-white tracking-tighter">OMW <span className="text-blue-500">2026</span></h1>
                    <div className="text-xs text-slate-500 font-mono mt-1">ATHLETE PROTOCOL V3.4</div>
                  </div>
                  <NavButton id="dashboard" icon={LayoutDashboard} label="DASHBOARD" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                  <NavButton id="calendar" icon={CalendarIcon} label="CALENDAR" active={activeTab === 'calendar'} onClick={() => setActiveTab('calendar')} />
                  <NavButton id="fuel" icon={Flame} label="FUEL" active={activeTab === 'fuel'} onClick={() => setActiveTab('fuel')} />
                  <NavButton id="supplements" icon={Pill} label="SUPPLEMENTS" active={activeTab === 'supplements'} onClick={() => setActiveTab('supplements')} />
                  <NavButton id="recovery" icon={Activity} label="RECOVERY" active={activeTab === 'recovery'} onClick={() => setActiveTab('recovery')} />
                  <NavButton id="gear" icon={Settings} label="GEAR" active={activeTab === 'gear'} onClick={() => setActiveTab('gear')} />
                </div>
              </nav>

              <main className="flex-1 overflow-y-auto p-4 pb-24 lg:p-8 no-scrollbar scroll-smooth">
                {activeTab === 'dashboard' && (
                  <DashboardView 
                    week={week} setWeek={setWeek} 
                    day={day} setDay={setDay} 
                    weekData={weekData} dayData={dayData}
                    checkedItems={checkedItems} toggleCheck={toggleCheck}
                    comments={comments} saveComment={saveComment}
                    jumpToRecovery={jumpToRecovery}
                    jumpToFuel={jumpToFuel}
                    openSuppModal={setActiveSupplement}
                    openFuelModal={openFuelModal}
                  />
                )}
                {activeTab === 'calendar' && <CalendarView goToDay={goToDay} />}
                {activeTab === 'fuel' && <FuelView weekData={weekData} dayData={dayData} />}
                {activeTab === 'supplements' && <SupplementsView />}
                {activeTab === 'recovery' && <RecoveryView targetRecovery={targetRecovery} />}
                {activeTab === 'gear' && <GearView temp={temp} setTemp={setTemp} cond={cond} setCond={setCond} />}
              </main>
            </div>
          );
        }

        function NavButton({ id, icon: Icon, label, active, onClick }) {
          return (
            <button onClick={onClick} className={`flex flex-col lg:flex-row items-center lg:px-4 lg:py-3 rounded-md transition-all ${active ? 'text-blue-400 bg-slate-800 shadow-lg shadow-blue-900/10' : 'text-slate-500 hover:bg-slate-800'}`}>
              <Icon className="w-5 h-5 mb-1 lg:mb-0 lg:mr-3" />
              <span className="text-[10px] lg:text-sm font-bold">{label}</span>
            </button>
          );
        }

        function CalendarView({ goToDay }) {
          return (
            <div className="animate-in fade-in duration-500">
              <div className="mb-6">
                <h2 className="text-2xl font-bold text-white mb-1">Training Calendar</h2>
                <p className="text-slate-400 text-sm">9-Week Overview</p>
              </div>
              <div className="grid grid-cols-8 gap-2 text-center text-xs font-bold text-slate-500 uppercase mb-2">
                <div className="text-left pl-2">Week</div>
                <div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div><div>S</div>
              </div>
              <div className="space-y-2">
                {Object.entries(WEEKS).map(([wNum, data]) => (
                  <div key={wNum} className="grid grid-cols-8 gap-2 items-start">
                    <div className="text-left pl-2 text-xs font-bold text-slate-400 pt-2">W{wNum}</div>
                    {data.days.map((d, i) => {
                        const date = getWorkoutDate(parseInt(wNum), i);
                        const dateNum = date.getDate();

                        return (
                            <div 
                              key={i} 
                              onClick={() => goToDay(parseInt(wNum), i)}
                              className="min-h-[60px] bg-slate-800 border border-slate-700 rounded-sm p-1 cursor-pointer hover:border-blue-500 hover:bg-slate-700 transition-all flex flex-col gap-1 relative"
                            >
                              <div className="absolute top-0.5 right-1 text-[8px] text-slate-500 font-mono">{dateNum}</div>
                              {d.workouts.length > 0 ? d.workouts.map((w, idx) => {
                                  let bgClass = "bg-slate-700 text-slate-400";
                                  if (w.t === "Run") bgClass = "bg-emerald-900/50 text-emerald-400 border border-emerald-500/20";
                                  if (w.t === "Swim") bgClass = "bg-blue-900/50 text-blue-400 border border-blue-500/20";
                                  if (w.t === "Bike") bgClass = "bg-orange-900/50 text-orange-400 border border-orange-500/20";
                                  if (w.t === "Rest") bgClass = "bg-slate-700/50 text-slate-500";
                                  
                                  return (
                                    <div key={idx} className={`text-[8px] leading-tight p-1 rounded-sm font-bold truncate mt-2 ${bgClass}`}>
                                      {w.title}
                                    </div>
                                  );
                              }) : (
                                  <div className="text-[8px] text-slate-600 p-1 text-center mt-3">REST</div>
                              )}
                            </div>
                        );
                    })}
                  </div>
                ))}
              </div>
            </div>
          );
        }
// --- NEW HELPER: Determine best recovery based on highest TSS workout ---
const getDailyRecovery = (dayData) => {
    if (!dayData.workouts || dayData.workouts.length === 0) {
        // Default to Routine B (Mobility) on Rest Days
        return RECOVERY_ROUTINES['B']; 
    }
    // Find workout with highest TSS to dictate recovery focus
    const hardest = [...dayData.workouts].sort((a, b) => b.tss - a.tss)[0];
    return RECOVERY_ROUTINES[hardest.rec] || RECOVERY_ROUTINES['A'];
};

// --- NEW COMPONENT: Daily Recovery Block ---
function DailyRecoveryCard({ routine, uid, checkedItems, toggleCheck, onOpen }) {
    const isDone = checkedItems[uid];
    
    return (
        <div className={`bg-slate-800 rounded-md p-4 border ${isDone ? 'border-green-900/50 bg-green-900/10' : 'border-indigo-500/30'} relative overflow-hidden transition-all`}>
            <div className="flex justify-between items-start mb-2">
                <div className="text-[10px] text-indigo-400 font-bold uppercase flex items-center gap-2">
                    <Activity size={12}/> Recovery Protocol
                </div>
                <button onClick={() => toggleCheck(uid)} className="text-slate-400 hover:text-white">
                    {isDone ? <CheckSquare size={18} className="text-green-500"/> : <Square size={18}/>}
                </button>
            </div>
            
            <div className={isDone ? "opacity-50 grayscale transition-all" : ""}>
                <h3 className="text-lg font-bold text-white leading-tight mb-1">{routine.title}</h3>
                <p className="text-xs text-slate-400 mb-3">{routine.sub}</p>
                
                <button 
                    onClick={onOpen} 
                    className="w-full py-2 bg-slate-900 hover:bg-indigo-900/50 text-indigo-300 text-xs font-bold rounded border border-slate-700 hover:border-indigo-500/50 transition-all flex items-center justify-center gap-2"
                >
                    <PlayCircle size={14}/> Start Routine ({routine.time})
                </button>
            </div>
        </div>
    );
}
   function DashboardView({ week, setWeek, day, setDay, weekData, dayData, checkedItems, toggleCheck, comments, saveComment, jumpToRecovery, jumpToFuel, openSuppModal, openFuelModal }) {
    
    // State for the Post-Workout Log Modal
    const [activeModal, setActiveModal] = useState(null); 
    const [activeUid, setActiveUid] = useState(null);

    // NEW: State for the Recovery Modal
    const [recModalOpen, setRecModalOpen] = useState(false);

    const currentDate = getWorkoutDate(week, day);
    const dateString = formatDate(currentDate);

    // Calculate Daily Recovery
    const dailyRec = getDailyRecovery(dayData);
    const recUid = `w${week}d${day}rec`; 

    // Workout Check Handler
    const handleCheckClick = (uid, workout) => {
        if (checkedItems[uid]) {
            toggleCheck(uid); 
        } else {
            setActiveUid(uid);
            setActiveModal(workout);
        }
    };

    // Log Save Handler
    const handleSaveLog = (logData) => {
        if (logData.notes) saveComment(activeUid, logData.notes);
        const finalNote = `RPE: ${logData.rpe}/10 | Time: ${logData.dur} \n${logData.notes}`;
        saveComment(activeUid, finalNote);
        toggleCheck(activeUid);
        setActiveModal(null);
        setActiveUid(null);
    };

    return (
    <div className="animate-in fade-in duration-500">
        
        {/* Workout Log Modal */}
        <PostWorkoutModal 
            isOpen={!!activeModal} 
            data={activeModal || {}} 
            onClose={() => setActiveModal(null)} 
            onSave={handleSaveLog} 
        />

        {/* NEW: Recovery Routine Modal */}
        <RecoveryModal 
            isOpen={recModalOpen}
            onClose={() => setRecModalOpen(false)}
            routine={dailyRec}
            uid={recUid}
            isCompleted={checkedItems[recUid]}
            toggleCheck={toggleCheck}
        />

        <div className="flex items-end justify-between mb-6">
            <div>
                <div className="text-[10px] bg-blue-900/30 text-blue-400 px-2 py-1 rounded-sm inline-block font-bold uppercase mb-2">
                    Week {week} â€¢ {weekData.title}
                </div>
                <h2 className="text-3xl font-black text-white italic tracking-tight">{weekData.focus}</h2>
                <div className="text-sm text-slate-400 mt-1 font-mono">{dateString}</div>
            </div>
        </div>

        <div className="flex overflow-x-auto gap-1 pb-4 no-scrollbar mb-4">
            {Object.keys(WEEKS).map((w) => (
                <button key={w} onClick={() => { setWeek(Number(w)); setDay(0); }} className={`flex-shrink-0 w-10 h-10 rounded-sm text-xs font-bold transition-all border ${week === Number(w) ? 'bg-blue-600 border-blue-500 text-white shadow-lg' : 'bg-slate-900 border-slate-800 text-slate-500 hover:bg-slate-800'}`}>W{w}</button>
            ))}
        </div>

        <div className="grid grid-cols-7 gap-1 mb-8">
            {['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'].map((d, i) => (
                <button key={i} onClick={() => setDay(i)} className={`h-10 rounded-sm text-[10px] font-bold transition-all border ${day === i ? 'bg-slate-200 border-white text-slate-900' : 'bg-slate-900 border-slate-800 text-slate-500 hover:bg-slate-800'}`}>{d}</button>
            ))}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-4">
                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Daily Objectives</h3>
                {dayData.workouts.map((workout, idx) => (
                <WorkoutCard 
                    key={idx} 
                    data={workout} 
                    uid={`w${week}d${day}w${idx}`}
                    checkedItems={checkedItems}
                    toggleCheck={() => handleCheckClick(`w${week}d${day}w${idx}`, workout)}
                    toggleItem={toggleCheck}
                    comments={comments}
                    saveComment={saveComment}
                    openFuelModal={openFuelModal}
                />
                ))}
            </div>

            {/* SIDEBAR */}
            <div className="space-y-4">
                
                {/* 1. DAILY RECOVERY */}
                <DailyRecoveryCard 
                    routine={dailyRec}
                    uid={recUid}
                    checkedItems={checkedItems}
                    toggleCheck={toggleCheck}
                    // CHANGED: Open the modal instead of jumping pages
                    onOpen={() => setRecModalOpen(true)}
                />

                {/* 2. DAILY STACK */}
                <div className="bg-slate-800 rounded-md p-4 border border-slate-700">
                    <div className="flex items-center justify-between mb-4">
                        <div className="text-[10px] text-slate-500 font-bold uppercase flex items-center gap-2"><Zap size={12} className="text-yellow-500"/> Daily Stack</div>
                    </div>
                    <div className="space-y-2">
                    {dayData.stack && dayData.stack.map((item, i) => {
                        const uid = `w${week}d${day}s${i}`;
                        return (
                        <div key={i} className="flex items-center justify-between bg-slate-900/50 p-2 rounded-sm border border-slate-700/50 hover:bg-slate-900 transition-colors cursor-pointer group" onClick={() => toggleCheck(uid)}>
                            <div className="flex items-center gap-2">
                                <button className={checkedItems[uid] ? 'text-green-500' : 'text-slate-600 hover:text-slate-400'}>{checkedItems[uid] ? <CheckSquare size={16}/> : <Square size={16}/>}</button>
                                <span className={`text-xs font-bold ${checkedItems[uid] ? 'text-slate-500 line-through' : 'text-slate-300 group-hover:text-white'}`}>{item}</span>
                            </div>
                            <div onClick={(e) => { e.stopPropagation(); openSuppModal(item); }}><Info size={12} className="text-slate-600 group-hover:text-blue-400 cursor-pointer"/></div>
                        </div>
                        )
                    })}
                    </div>
                </div>

                {/* 3. FUELING */}
                {dayData.workouts[0] && (
                <div className="bg-slate-800 rounded-md p-4 border border-slate-700 relative overflow-hidden group">
                    <div className={`absolute top-0 right-0 p-1.5 rounded-bl-lg ${dayData.workouts[0].fl === 'High' ? 'bg-green-500 text-black' : dayData.workouts[0].fl === 'Low' ? 'bg-red-500 text-white' : 'bg-yellow-500 text-black'}`}><Flame size={14} /></div>
                    <div className="text-[10px] text-slate-500 font-bold uppercase mb-2">Fueling Strategy</div>
                    <div className="text-xl font-bold text-white mb-1">{dayData.workouts[0].fl} Flux</div>
                    <p className="text-[10px] text-slate-400 leading-relaxed mb-3">{FLUX_DATA[dayData.workouts[0].fl]?.desc || "Standard Protocol"}</p>
                    <button onClick={jumpToFuel} className="w-full py-2 rounded-sm bg-slate-700 hover:bg-slate-600 text-xs font-bold text-slate-200 transition-colors">View Menu</button>
                </div>
                )}
            </div>
        </div>
    </div>
    );
}
        function WorkoutCard({ data, uid, checkedItems, toggleCheck, toggleItem, comments, saveComment, openFuelModal }) {
    const colors = {
        'Swim': { head: 'bg-blue-600', text: 'text-blue-400', border: 'border-blue-500/30' },
        'Run': { head: 'bg-emerald-600', text: 'text-emerald-400', border: 'border-emerald-500/30' },
        'Bike': { head: 'bg-orange-600', text: 'text-orange-400', border: 'border-orange-500/30' }
    }[data.t] || { head: 'bg-slate-600', text: 'text-slate-400', border: 'border-slate-500/30' };

    const isCompleted = checkedItems[uid];
    const fuelTarget = INTRA_FUEL_OPTIONS[data.fl]?.target || '0g/hr';

    return (
    <div className={`bg-slate-800 rounded-md overflow-hidden border ${colors.border} shadow-sm relative`}>
        {isCompleted && <div className="absolute top-0 right-0 p-4 z-10 opacity-10 pointer-events-none"><CheckSquare size={100} /></div>}

        <div className={`${colors.head} px-4 py-3 flex justify-between items-center z-20 relative`}>
        <div className="flex items-center gap-2">
            <span className="font-bold text-white uppercase text-sm tracking-wider">{data.t}</span>
            <span className="text-white/60 text-xs">|</span>
            <span className="text-white font-mono text-xs">{data.dur}</span>
        </div>
        <div className="flex items-center gap-3">
            <span className="bg-black/20 px-2 py-0.5 rounded text-[10px] font-bold text-white/90">{data.tss} TSS</span>
            <button onClick={() => toggleCheck(uid)} className="flex items-center gap-1 text-white/90 hover:text-white transition-colors text-[10px] font-bold uppercase bg-black/10 px-2 py-1 rounded hover:bg-black/20">
                {isCompleted ? <CheckSquare size={14} /> : <Square size={14} />}
                <span>{isCompleted ? "Completed" : "Mark Complete"}</span>
            </button>
        </div>
        </div>
        <div className="p-5 relative z-20">
        <h3 className={`font-bold text-xl text-white mb-1 ${isCompleted ? 'opacity-50' : ''}`}>{data.title}</h3>
        <div className="text-xs text-slate-400 font-mono mb-4 uppercase tracking-wider flex items-center gap-2">
            <Dumbbell size={12}/> Goal: {data.goal}
        </div>
        
        <div className={`bg-slate-900/50 p-4 rounded-sm mb-4 border-l-2 border-slate-600 ${isCompleted ? 'opacity-50' : ''}`}>
            {data.ex.map((line, i) => (
                <div key={i} className="mb-2 last:mb-0 text-sm font-medium text-slate-300 flex items-start gap-2">
                <span className="text-slate-600 mt-1.5 w-1 h-1 bg-slate-600 rounded-full flex-shrink-0"></span>
                {line}
                </div>
            ))}
        </div>

        {data.supps && data.supps.length > 0 && (
            <div className={`mb-4 ${isCompleted ? 'opacity-50' : ''}`}>
                <div className="text-[10px] text-slate-500 font-bold uppercase mb-2">Session Stack</div>
                <div className="flex flex-wrap gap-2">
                    {data.supps.map((supp, i) => {
                        const suppUid = `${uid}_supp_${i}`;
                        return (
                            <button 
                                key={i} 
                                onClick={() => toggleItem(suppUid)}
                                className={`text-xs px-2 py-1 rounded border flex items-center gap-2 transition-all ${checkedItems[suppUid] ? 'bg-green-900/30 border-green-500/50 text-green-400' : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-700'}`}
                            >
                                {checkedItems[suppUid] ? <CheckSquare size={12}/> : <Square size={12}/>}
                                {supp}
                            </button>
                        );
                    })}
                </div>
            </div>
        )}

        {/* Footer Actions - REMOVED RECOVERY BUTTON */}
        <div className="flex gap-2 mb-4">
            <button onClick={() => openFuelModal(data.fl)} className="w-full py-2 rounded-sm bg-slate-700/50 hover:bg-slate-700 border border-slate-600 text-xs font-bold text-slate-300 transition-colors flex items-center justify-center gap-2">
                <Flame size={12} className="text-orange-400"/> Fuel: {fuelTarget}
            </button>
        </div>

        {isCompleted ? (
            <div className="bg-emerald-900/10 border border-emerald-500/20 rounded p-3 mt-4 animate-in fade-in slide-in-from-bottom-2">
                <div className="text-[10px] text-emerald-500 font-bold uppercase mb-1 flex items-center gap-1">
                    <CheckSquare size={10}/> Session Log
                </div>
                <div className="text-sm text-slate-300 whitespace-pre-wrap font-medium">
                    {comments[uid] || "No logs recorded."}
                </div>
            </div>
        ) : (
            <div className="opacity-50 hover:opacity-100 transition-opacity">
                <div className="text-[10px] text-slate-500 font-bold uppercase mb-1 flex items-center gap-1">
                    <MessageSquare size={10}/> Pre-Session Notes
                </div>
                <textarea 
                    className="w-full bg-slate-900/50 border border-slate-700 rounded-sm p-2 text-xs text-slate-300 focus:outline-none focus:border-blue-500/50 transition-colors"
                    rows="1"
                    placeholder="Notes..."
                    value={comments[uid] || ''}
                    onChange={(e) => saveComment(uid, e.target.value)}
                />
            </div>
        )}
        </div>
    </div>
    );
}

        function SupplementsView() {
            return (
                <div className="animate-in fade-in space-y-6">
                    <div className="bg-slate-800 p-6 rounded-md border border-slate-700">
                        <div className="flex items-center gap-3 mb-6">
                            <Pill className="text-blue-400 w-6 h-6" />
                            <h2 className="text-2xl font-bold text-white">Supplement Protocol</h2>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm text-slate-400">
                                <thead className="text-xs uppercase bg-slate-900 text-slate-300">
                                    <tr>
                                        <th className="px-4 py-3 rounded-tl-md">Supplement</th>
                                        <th className="px-4 py-3">Type</th>
                                        <th className="px-4 py-3">Dose & Timing</th>
                                        <th className="px-4 py-3 rounded-tr-md">Objective</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-700">
                                    {Object.entries(SUPPLEMENT_INFO).map(([key, info]) => (
                                        <tr key={key} className="hover:bg-slate-700/30 transition-colors">
                                            <td className="px-4 py-3 font-medium text-white">{info.title}</td>
                                            <td className="px-4 py-3">
                                                <span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${info.type === 'Daily' ? 'bg-blue-900/30 text-blue-400' : 'bg-orange-900/30 text-orange-400'}`}>
                                                    {info.type}
                                                </span>
                                            </td>
                                            <td className="px-4 py-3 text-slate-300">{info.dose}</td>
                                            <td className="px-4 py-3">{info.why}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function FuelView({ weekData, dayData }) {
          // Initialize activeFlux with the day's flux, or default to Moderate
          const defaultFlux = dayData?.workouts?.[0]?.fl || 'Moderate';
          const [activeFlux, setActiveFlux] = useState(defaultFlux);

          // Update local state when day/week changes
          useEffect(() => {
              setActiveFlux(defaultFlux);
          }, [defaultFlux]);

          const data = FLUX_DATA[activeFlux];
          const colors = {
            'green': { bg: 'bg-emerald-900/20', border: 'border-emerald-500/50', icon: 'text-emerald-400' },
            'yellow': { bg: 'bg-yellow-900/20', border: 'border-yellow-500/50', icon: 'text-yellow-400' },
            'red': { bg: 'bg-red-900/20', border: 'border-red-500/50', icon: 'text-red-400' }
          }[data.color];

          // Check if there is a swim workout scheduled for today (regardless of active flux tab)
          const hasSwim = dayData.workouts.some(w => w.t === 'Swim');
          const preSwimVal = hasSwim ? "Banana + Blank's Custom Mix" : data.preSwim;

          return (
            <div className="animate-in fade-in space-y-6">
              {/* Flux Selector Tabs */}
              <div className="flex bg-slate-800 p-1 rounded-md border border-slate-700">
                  {['High', 'Moderate', 'Low'].map(flux => (
                      <button 
                          key={flux}
                          onClick={() => setActiveFlux(flux)}
                          className={`flex-1 py-2 text-xs font-bold uppercase rounded-sm transition-all ${activeFlux === flux ? 'bg-slate-600 text-white shadow' : 'text-slate-500 hover:text-slate-300'}`}
                      >
                          {flux} Flux
                      </button>
                  ))}
              </div>

              <div className={`p-6 rounded-md border ${colors.bg} ${colors.border}`}>
                <div className="flex items-center gap-3 mb-2">
                  <Flame className={`${colors.icon} w-6 h-6`} />
                  <h2 className="text-2xl font-bold text-white">{activeFlux} Flux</h2>
                </div>
                <p className="text-slate-300 text-sm leading-relaxed">{data.desc}</p>
              </div>
              <div className="bg-slate-800 rounded-md overflow-hidden border border-slate-700">
                <div className="bg-slate-900 p-4 border-b border-slate-700 font-bold text-white text-xs uppercase tracking-wider">Daily Protocol</div>
                <div className="divide-y divide-slate-700">
                  <FuelRow icon={Waves} label="Pre-Swim" val={preSwimVal} />
                  <FuelRow icon={Coffee} label="Breakfast" val={data.b} />
                  <FuelRow icon={Utensils} label="Lunch" val={data.l} />
                  <FuelRow icon={Zap} label="Pre-Workout" val={data.pre} />
                  <FuelRow icon={Droplets} label="Intra-Workout" val={data.intra} />
                  <FuelRow icon={Utensils} label="Dinner" val={data.d} />
                </div>
              </div>
            </div>
          );
        }

        function FuelRow({ icon: Icon, label, val }) {
          return (
            <div className="p-4 flex gap-4 items-center">
              <Icon className="text-slate-500 w-5 h-5 flex-shrink-0" />
              <div>
                <div className="text-[10px] text-slate-500 font-bold uppercase">{label}</div>
                <div className="text-slate-200 text-sm font-medium">{val}</div>
              </div>
            </div>
          );
        }

        function RecoveryView({ targetRecovery }) {
          const [activeGif, setActiveGif] = useState(null); 

          useEffect(() => {
            if (targetRecovery) {
              const el = document.getElementById(`rec-${targetRecovery}`);
              if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, [targetRecovery]);

          return (
            <div className="animate-in fade-in">
              {/* GIF MODAL */}
              <GifModal 
                isOpen={!!activeGif}
                gifUrl={activeGif?.url}
                title={activeGif?.title}
                onClose={() => setActiveGif(null)}
              />

              <div className="bg-gradient-to-r from-indigo-900/50 to-slate-900 p-6 rounded-md border border-indigo-500/30 mb-6">
                <h2 className="text-2xl font-bold text-white mb-1">Recovery Vault</h2>
                <p className="text-indigo-200/70 text-sm">Mechanical routines to reset the nervous system.</p>
              </div>
              <div className="grid gap-4">
                {Object.values(RECOVERY_ROUTINES).map((r) => {
                  const isTarget = targetRecovery === r.id;
                  return (
                    <div key={r.id} id={`rec-${r.id}`} className={`p-5 rounded-md border transition-all ${isTarget ? 'border-indigo-500 bg-indigo-900/20 ring-1 ring-indigo-500' : 'border-slate-700 bg-slate-800'}`}>
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h3 className="text-lg font-bold text-white">{r.title}</h3>
                          <p className="text-indigo-400 text-xs font-bold uppercase tracking-wider">{r.sub}</p>
                        </div>
                        <span className="text-[10px] bg-slate-900 px-2 py-1 rounded text-slate-400 border border-slate-700 font-mono">{r.time}</span>
                      </div>
                      <div className="space-y-3 relative">
                        <div className="absolute left-2.5 top-2 bottom-2 w-px bg-slate-700/50"></div>
                        {r.steps.map((step, i) => (
                          <div key={i} className="flex items-center justify-between group relative z-10 pl-8">
                            <div className="absolute left-0 top-0.5 flex-shrink-0 w-5 h-5 rounded-full bg-slate-800 border border-slate-700 text-[10px] flex items-center justify-center text-slate-400 font-mono">
                                {i + 1}
                            </div>
                            <div className="flex-1 pr-2">
                                <span className="text-sm text-slate-300 leading-snug font-medium block">{step.name}</span>
                                <span className="text-xs text-slate-500 font-mono">{step.time}</span>
                            </div>
                            {step.gif && (
                                <button 
                                    onClick={() => setActiveGif({ url: step.gif, title: step.name })}
                                    className="text-slate-600 hover:text-indigo-400 transition-colors"
                                    title="Watch Demo"
                                >
                                    <PlayCircle size={18} />
                                </button>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          );
        }

        function GearView({ temp, setTemp, cond, setCond }) {
            const [sport, setSport] = useState("Bike");
            const [wind, setWind] = useState("Low");
            const [loading, setLoading] = useState(false);
            const [weatherData, setWeatherData] = useState(null);
            const [manualOverride, setManualOverride] = useState(false);
            const [searchQuery, setSearchQuery] = useState(""); // State for user input

    // HELPER: Map Numeric Temp to Range Key
    const getRange = (t) => {
        if (t < 20) return "10-20F";
        if (t < 30) return "20-30F";
        if (t < 40) return "30-40F";
        if (t < 50) return "40-50F";
        if (t < 60) return "50-60F";
        if (t < 70) return "60-70F";
        if (t < 80) return "70-80F";
        if (t < 90) return "80-90F";
        return "90F+";
    };

    // WEATHER FETCH
    // Now accepts an optional 'location' argument
    const fetchWeather = async (customLoc = null) => {
        setLoading(true);
        try {
            let lat = "40.0150"; // Default Boulder
            let lon = "-105.2705";
            let locationName = "Boulder (Default)";

            // 1. If user searches, use Nominatim (OpenStreetMap) for "City, State" support
            if (customLoc) {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(customLoc)}&format=json`);
                const geoData = await geoRes.json();
                
                if (!geoData || geoData.length === 0) throw new Error("Location not found");
                
                lat = geoData[0].lat;
                lon = geoData[0].lon;
                locationName = geoData[0].display_name.split(',')[0]; // Grabs just the city name for display
            }

            // 2. Fetch Weather from Open-Meteo (Uses the lat/lon we just found)
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,rain,showers,snowfall,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`);
            const data = await res.json();

            if (data.current) {
                const currentTemp = data.current.temperature_2m;
                const range = getRange(currentTemp);
                setTemp(range);

                const isWet = (data.current.rain > 0 || data.current.showers > 0 || data.current.snowfall > 0);
                setCond(isWet ? "Wet" : "Dry");

                setWind(data.current.wind_speed_10m > 15 ? "High" : "Low");

                setWeatherData({
                    temp: Math.round(currentTemp),
                    desc: isWet ? "Precipitation" : "Clear/Cloudy",
                    wind: Math.round(data.current.wind_speed_10m),
                    loc: customLoc ? locationName : "Boulder (Default)"
                });
                setManualOverride(false);
                setSearchQuery(""); 
            }
        } catch (e) {
            console.error("Weather Fetch Failed", e);
            alert("Could not find that location. Try spelling it out (e.g. 'Rochester, New York')");
        }
        setLoading(false);
    };

            // 1. Fetch Boulder on mount (Missing in your snippet)
    useEffect(() => {
        fetchWeather();
        // ... inside GearView, after useEffect ...

    const handleSearch = (e) => {
        e.preventDefault();
        if (searchQuery.trim()) {
            fetchWeather(searchQuery);
        }
    };

    // 2. Handle Search Button (Fixes the Crash)
    const handleSearch = (e) => {
        e.preventDefault();
        if (searchQuery.trim()) {
            fetchWeather(searchQuery);
        }
    };

    const handleOverride = (setter, val) => {
        setter(val);
        setManualOverride(true);
    };
     
    // Safe Data Access
    const safeTemp = GEAR_MATRIX[temp] ? temp : "30-40F";
    const safeSport = GEAR_MATRIX[safeTemp][sport] ? sport : "Bike";
    const safeCond = GEAR_MATRIX[safeTemp][safeSport][cond] ? cond : "Dry";
    
    // Get Base Gear + Wind Modifier
    const gearSet = GEAR_MATRIX[safeTemp][safeSport][safeCond];
    const windMod = (wind === "High" && gearSet.w) ? gearSet.w : null;

    return (
        <div className="animate-in fade-in space-y-6">
            <div className="bg-slate-800 p-6 rounded-md border border-slate-700">
                
                {/* HEADER & SEARCH */}
                <div className="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-6 gap-4">
                    <div className="flex-1">
                        <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                            Gear Calculator
                            {manualOverride && <span className="text-[10px] bg-yellow-900/50 text-yellow-500 px-2 py-0.5 rounded border border-yellow-700/50">MANUAL OVERRIDE</span>}
                        </h2>
                        
                        {/* Live Weather Display */}
                        {weatherData ? (
                            <div className="flex items-center gap-3 mt-2 text-sm bg-slate-900/50 p-2 rounded-md border border-slate-700/50 inline-flex">
                                <span className="text-blue-400 font-bold uppercase">{weatherData.loc}</span> 
                                <span className="text-white font-mono font-bold">{weatherData.temp}Â°F</span>
                                <span className="text-slate-400 capitalize">{weatherData.desc}</span>
                                <span className={`font-bold ${weatherData.wind > 15 ? 'text-red-400' : 'text-slate-500'}`}>Wind {weatherData.wind}mph</span>
                            </div>
                        ) : (
                            <p className="text-slate-400 text-sm mt-1">Weather data unavailable</p>
                        )}
                    </div>

                    {/* Search Form */}
                    <form onSubmit={handleSearch} className="flex gap-2 w-full lg:w-auto">
                        <input 
                            type="text" 
                            placeholder="Enter City (e.g. Centennial)" 
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="bg-slate-900 border border-slate-700 text-white text-xs p-2 rounded w-full focus:outline-none focus:border-blue-500"
                        />
                        <button type="submit" disabled={loading} className="px-3 py-2 bg-slate-700 hover:bg-blue-600 text-white text-xs font-bold rounded transition-colors whitespace-nowrap">
                            {loading ? "..." : "SEARCH"}
                        </button>
                        <button type="button" onClick={() => fetchWeather()} className="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white border border-slate-700 text-xs font-bold rounded transition-colors whitespace-nowrap" title="Reset to Race Location">
                           <RefreshCcw size={14} />
                        </button>
                    </form>
                </div>

                {/* CONTROLS GRID */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    {/* SPORT */}
                    <div className="bg-slate-900 p-1 rounded border border-slate-700 flex">
                        <button onClick={() => setSport("Bike")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${sport === 'Bike' ? 'bg-slate-700 text-white shadow' : 'text-slate-500'}`}>BIKE</button>
                        <button onClick={() => setSport("Run")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${sport === 'Run' ? 'bg-emerald-900/50 text-emerald-400 shadow' : 'text-slate-500'}`}>RUN</button>
                    </div>

                    {/* TEMP */}
                    <select value={temp} onChange={(e) => handleOverride(setTemp, e.target.value)} className="bg-slate-900 border border-slate-700 text-white rounded p-2 text-xs font-bold outline-none">
                        {Object.keys(GEAR_MATRIX).map(t => <option key={t} value={t}>{t}</option>)}
                    </select>

                    {/* CONDITION */}
                    <div className="bg-slate-900 p-1 rounded border border-slate-700 flex">
                        <button onClick={() => handleOverride(setCond, "Dry")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${cond === 'Dry' ? 'bg-slate-700 text-yellow-500 shadow' : 'text-slate-500'}`}>DRY</button>
                        <button onClick={() => handleOverride(setCond, "Wet")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${cond === 'Wet' ? 'bg-blue-900/50 text-blue-400 shadow' : 'text-slate-500'}`}>WET</button>
                    </div>

                    {/* WIND */}
                    <div className="bg-slate-900 p-1 rounded border border-slate-700 flex">
                        <button onClick={() => handleOverride(setWind, "Low")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${wind === 'Low' ? 'bg-slate-700 text-slate-300 shadow' : 'text-slate-500'}`}>CALM</button>
                        <button onClick={() => handleOverride(setWind, "High")} className={`flex-1 rounded-sm text-xs font-bold transition-all ${wind === 'High' ? 'bg-red-900/50 text-red-400 shadow' : 'text-slate-500'}`}>WINDY</button>
                    </div>
                </div>

                {/* RESULTS */}
                <div className="space-y-4">
                    {/* WIND ALERT */}
                    {windMod && (
                        <div className="bg-red-900/20 border border-red-500/30 p-3 rounded flex items-start gap-3 animate-in slide-in-from-top-2">
                            <Wind className="text-red-400 w-5 h-5 mt-0.5" />
                            <div>
                                <div className="text-red-400 text-xs font-bold uppercase mb-1">High Wind Warning</div>
                                <div className="text-slate-200 text-sm font-medium">{windMod}</div>
                            </div>
                        </div>
                    )}

                    <div className="bg-slate-900 rounded-md p-5 border border-slate-700 space-y-5">
                        <GearRow icon={Wind} label="Upper Body" val={gearSet.u} color="blue" />
                        <GearRow icon={Activity} label="Lower Body" val={gearSet.l} color="blue" />
                        <GearRow icon={Thermometer} label="Extremities" val={gearSet.e} color="orange" />
                        {sport === 'Bike' ? (
                            <GearRow icon={Bike} label="Tire Choice" val={gearSet.t} color="green" />
                        ) : (
                            <GearRow icon={Waves} label="Footwear" val={gearSet.f} color="green" />
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}

        const RecoveryModal = ({ isOpen, onClose, routine, uid, isCompleted, toggleCheck }) => {
    if (!isOpen || !routine) return null;
    
    // Track which step is expanded to show the GIF
    const [expandedStep, setExpandedStep] = useState(null);

    const handleComplete = () => {
        if (!isCompleted) toggleCheck(uid); // Only toggle if not already done
        onClose();
    };

    return (
        <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={onClose}>
            <div className="bg-slate-900 border border-slate-700 rounded-lg max-w-md w-full p-6 shadow-2xl relative flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                
                {/* Header */}
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h3 className="text-xl font-bold text-white">{routine.title}</h3>
                        <p className="text-indigo-400 text-xs font-bold uppercase tracking-wider">{routine.sub} â€¢ {routine.time}</p>
                    </div>
                    <button onClick={onClose} className="text-slate-500 hover:text-white"><X size={24}/></button>
                </div>

                {/* Steps List (Scrollable) */}
                <div className="flex-1 overflow-y-auto mb-6 pr-2 space-y-3">
                    {routine.steps.map((step, i) => (
                        <div key={i} className="bg-slate-800/50 rounded border border-slate-700/50 p-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="flex-shrink-0 w-6 h-6 rounded-full bg-slate-700 text-slate-300 text-xs font-mono flex items-center justify-center">
                                        {i + 1}
                                    </div>
                                    <div>
                                        <div className="text-sm font-bold text-slate-200">{step.name}</div>
                                        <div className="text-xs text-slate-500 font-mono">{step.time}</div>
                                    </div>
                                </div>
                                {step.gif && (
                                    <button 
                                        onClick={() => setExpandedStep(expandedStep === i ? null : i)}
                                        className={`p-2 rounded-full transition-colors ${expandedStep === i ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400 hover:text-white'}`}
                                    >
                                        <PlayCircle size={16} />
                                    </button>
                                )}
                            </div>
                            
                            {/* Inline GIF Expansion */}
                            {expandedStep === i && step.gif && (
                                <div className="mt-3 rounded overflow-hidden aspect-video bg-black">
                                    <img src={step.gif} alt={step.name} className="w-full h-full object-contain" />
                                </div>
                            )}
                        </div>
                    ))}
                </div>

                {/* Footer Action */}
                <button 
                    onClick={handleComplete}
                    className={`w-full py-3 font-bold rounded flex items-center justify-center gap-2 transition-all ${isCompleted ? 'bg-green-600 text-white' : 'bg-indigo-600 hover:bg-indigo-500 text-white'}`}
                >
                    {isCompleted ? <CheckSquare size={18} /> : <Square size={18} />}
                    {isCompleted ? "ROUTINE COMPLETED" : "MARK COMPLETE"}
                </button>
            </div>
        </div>
    );
};
        function GearRow({ icon: Icon, label, val, color }) {
          const colorClasses = {
              'blue': 'bg-blue-500/20 text-blue-400',
              'orange': 'bg-orange-500/20 text-orange-400',
              'green': 'bg-green-500/20 text-green-400'
          }[color] || 'bg-slate-500/20 text-slate-400';

          return (
            <div className="flex gap-4 items-start">
              <div className={`${colorClasses} p-2 rounded mt-1`}><Icon className="w-4 h-4" /></div>
              <div>
                <div className="text-[10px] text-slate-500 uppercase font-bold">{label}</div>
                <div className="text-white font-medium text-sm">{val}</div>
              </div>
            </div>
          );
        }
const PostWorkoutModal = ({ isOpen, onClose, onSave, data }) => {
    if (!isOpen) return null;
    
    // Local state for the form
    const [rpe, setRpe] = useState(5);
    const [dur, setDur] = useState(data?.dur || "");
    const [notes, setNotes] = useState("");

    return (
        <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
            <div className="bg-slate-900 border border-slate-700 rounded-lg max-w-sm w-full p-6 shadow-2xl relative">
                <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white">
                    <X size={20} />
                </button>
                
                <h3 className="text-xl font-bold text-white mb-1">Mission Debrief</h3>
                <p className="text-slate-400 text-sm mb-6">{data.title}</p>

                {/* RPE SLIDER */}
                <div className="mb-6">
                    <div className="flex justify-between text-xs font-bold uppercase text-slate-500 mb-2">
                        <span>RPE (Exertion)</span>
                        <span className={rpe > 8 ? "text-red-500" : rpe > 5 ? "text-yellow-500" : "text-green-500"}>{rpe} / 10</span>
                    </div>
                    <input 
                        type="range" min="1" max="10" step="1" 
                        value={rpe} onChange={(e) => setRpe(parseInt(e.target.value))}
                        className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                    />
                    <div className="flex justify-between text-[10px] text-slate-600 mt-1 font-mono">
                        <span>Easy</span>
                        <span>Max Effort</span>
                    </div>
                </div>

                {/* DURATION & NOTES */}
                <div className="space-y-4 mb-6">
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Actual Duration</label>
                        <input 
                            type="text" value={dur} onChange={(e) => setDur(e.target.value)}
                            className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"
                        />
                    </div>
                    <div>
                        <label className="text-xs font-bold text-slate-500 uppercase block mb-1">Field Notes</label>
                        <textarea 
                            rows="3" value={notes} onChange={(e) => setNotes(e.target.value)}
                            className="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"
                            placeholder="How did the legs feel?"
                        />
                    </div>
                </div>

                <button 
                    onClick={() => onSave({ rpe, dur, notes })}
                    className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded flex items-center justify-center gap-2 transition-all"
                >
                    <Save size={16} /> SAVE LOG
                </button>
            </div>
        </div>
    );
};
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<TrainingApp />);
        } catch (error) {
            console.error("Render Error:", error);
            document.getElementById('error-box').style.display = 'block';
            document.getElementById('error-box').innerText = "Critical Render Error: " + error.message;
        }
    </script>
</body>
</html>
